name: ğŸš€ Space Debris Risk Assessment CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_to_azure:
        description: 'Deploy to Azure ML'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: 'Space-Debris-Risk-Assessment-RG'
  AZURE_ML_WORKSPACE: 'Space-Debris-Risk-Assessment'

jobs:
  test:
    name: ğŸ§ª Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-core.txt
        pip install pytest pytest-cov
        # Install optional dependencies individually to handle compatibility
        pip install sgp4>=2.20 || echo "sgp4 installation failed, continuing..."
        
    - name: ğŸ” Lint Code
      run: |
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: ğŸ§ª Run Tests
      run: |
        # Test TLE data loading (using the actual test_ml_app.py method)
        python -c "
        import sys
        import os
        sys.path.append('.')
        from test_ml_app import DebrisRiskTester
        tester = DebrisRiskTester()
        result = tester.load_tle_data()
        assert result, 'TLE data loading failed'
        assert len(tester.satellites) > 0, 'No satellites loaded'
        print(f'âœ… TLE loading test passed: {len(tester.satellites)} objects loaded')
        "
        
        # Test risk model with the actual class
        python -c "
        import sys
        sys.path.append('src')
        from risk_model import DebrisRiskModel
        model = DebrisRiskModel()
        # Create mock satellite and target data for testing
        satellite = {'altitude': 400, 'eccentricity': 0.01, 'inclination': 51.6}
        target = {'altitude': 410, 'eccentricity': 0.05, 'inclination': 52.0}
        risk = model.predict_risk(satellite, target)
        assert 0 <= risk <= 1, f'Risk score {risk} out of range'
        print(f'âœ… Risk model test passed: risk={risk:.3f}')
        "
        
    - name: ğŸ¯ Run Application Test
      run: |
        python test_ml_app.py --max-pairs 5 --format summary
        
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-core.txt
        # Install optional dependencies individually
        pip install sgp4>=2.20 || echo "sgp4 installation failed, continuing..."
        
    - name: ğŸ“Š Generate Test Report
      run: |
        python test_ml_app.py --max-pairs 20 --format json --save-output test_results.json
        
    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test_results.json
        
  deploy-azure:
    name: ğŸŒŠ Deploy to Azure ML
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event.inputs.deploy_to_azure == 'true') && secrets.AZURE_CREDENTIALS != ''
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ğŸ“¦ Install Azure ML SDK
      run: |
        python -m pip install --upgrade pip
        pip install azure-ai-ml azure-identity azure-cli
        
    - name: ğŸš€ Deploy to Azure ML
      run: |
        python deploy_simple.py
      env:
        AZURE_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
        
    - name: ğŸ§ª Test Deployment
      run: |
        python test_endpoint.py
      continue-on-error: true
      
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run Security Scan
      uses: pypa/gh-action-pip-audit@v1.0.8
      with:
        inputs: requirements.txt
      continue-on-error: true  # Don't fail the build on security warnings
        
  performance-test:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-core.txt
        pip install memory-profiler psutil
        
    - name: â±ï¸ Performance Benchmark
      run: |
        python -c "
        import time
        import psutil
        import os
        
        # Memory usage before
        process = psutil.Process(os.getpid())
        mem_before = process.memory_info().rss / 1024 / 1024
        
        # Time the application
        start_time = time.time()
        os.system('python test_ml_app.py --max-pairs 50 --format summary')
        end_time = time.time()
        
        # Memory usage after
        mem_after = process.memory_info().rss / 1024 / 1024
        
        print(f'âš¡ Performance Results:')
        print(f'   Execution Time: {end_time - start_time:.2f} seconds')
        print(f'   Memory Usage: {mem_after:.2f} MB (Î”{mem_after - mem_before:.2f} MB)')
        "

  azure-info:
    name: â„¹ï¸ Azure Deployment Info
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && secrets.AZURE_CREDENTIALS == ''
    
    steps:
    - name: ğŸ“‹ Azure Setup Instructions
      run: |
        echo "ğŸ”µ Azure Deployment Skipped"
        echo "================================"
        echo "Azure deployment was skipped because AZURE_CREDENTIALS secret is not configured."
        echo ""
        echo "To enable Azure ML deployment:"
        echo "1. Create an Azure service principal:"
        echo "   az ad sp create-for-rbac --name 'space-debris-github-actions' --role contributor --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group} --sdk-auth"
        echo ""
        echo "2. Add the output as AZURE_CREDENTIALS secret in your GitHub repository"
        echo "3. Set these repository secrets:"
        echo "   - AZURE_CREDENTIALS (service principal JSON)"
        echo "   - Optionally update environment variables in workflow"
        echo ""
        echo "For more information, see: https://github.com/Azure/login#configure-deployment-credentials"
        echo ""
        echo "âœ… Application testing and building completed successfully!"
