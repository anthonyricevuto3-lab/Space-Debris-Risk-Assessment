name: Space Debris Risk Assessment CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# GitHub Pages permissions
permissions:
  contents: read
  pages: write
  id-token: write

env:
  PYTHON_VERSION: '3.11'
  AZURE_RESOURCE_GROUP: 'space-debris-rg'
  AZURE_APP_NAME: 'space-debris-assessment'

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    
    steps:
    - name: üöÄ Checkout Code
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üì¶ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: üîß Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8
        
    - name: üßπ Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: üß™ Test Application Import
      run: |
        python -c "import main; print('‚úÖ Application import successful')"
        
    - name: üåê Test Flask Application
      run: |
        python -c "
        from main import app
        with app.test_client() as client:
            response = client.get('/')
            assert response.status_code == 200
            response = client.get('/api/health')
            assert response.status_code == 200
            print('‚úÖ Flask application test successful')
        "

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: üöÄ Checkout Code
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üîß Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: üèóÔ∏è Generate Static Site
      run: |
        python -c "
        from main import app
        import os
        
        # Create dist directory
        os.makedirs('dist', exist_ok=True)
        
        # Generate static HTML
        with app.test_client() as client:
            response = client.get('/')
            with open('dist/index.html', 'w', encoding='utf-8') as f:
                f.write(response.get_data(as_text=True))
        
        print('‚úÖ Static site generated successfully')
        "
        
    - name: üìÅ Copy Static Assets
      run: |
        # Copy app static assets if they exist
        if [ -d "app/static" ]; then
          cp -r app/static/* dist/ 2>/dev/null || echo "No static files found"
        fi
        # Create a basic CSS file if none exists
        if [ ! -f "dist/style.css" ]; then
          echo "/* Space Debris Risk Assessment - Student Project by Anthony Ricevuto */" > dist/style.css
        fi
        echo "‚úÖ Static assets prepared"
        
    - name: üìÑ Setup Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true  # Enable GitHub Pages if not already enabled
        
    - name: üì§ Upload Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist
        
    - name: üåê Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: üöÄ Checkout Code
      uses: actions/checkout@v4
      
    - name: üõ°Ô∏è Run Security Scan
      uses: pypa/gh-action-pip-audit@v1.0.8
      with:
        inputs: requirements.txt
      continue-on-error: true  # Don't fail the build on security warnings
        
  build:
    name: üì¶ Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: üöÄ Checkout Code
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üîß Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Test that our main application works
        python -c "import main; print('‚úÖ App import successful')"
        
    - name: üìä Generate Test Report
      run: |
        python -c "
        from main import app
        import json
        
        # Test main application
        with app.test_client() as client:
            response = client.get('/api/health')
            status_ok = response.status_code == 200
        
        test_results = {
          'status': 'success' if status_ok else 'failed',
          'app_tested': True,
          'health_check': status_ok
        }
        
        with open('test_results.json', 'w') as f:
          json.dump(test_results, f)
        
        print('‚úÖ Test report generated')
        "
        
    - name: üì§ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test_results.json
        
  deploy-azure:
    name: ‚òÅÔ∏è Deploy to Azure
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: üöÄ Checkout Code
      uses: actions/checkout@v4
      
    - name: üîç Check Azure Credentials
      id: check-creds
      run: |
        if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
          echo "skip-deployment=true" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Azure credentials not configured, skipping deployment"
        else
          echo "skip-deployment=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Azure credentials found, proceeding with deployment"
        fi
      
    - name: üêç Set up Python
      if: steps.check-creds.outputs.skip-deployment == 'false'
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üîë Azure Login
      if: steps.check-creds.outputs.skip-deployment == 'false'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: üîß Install Dependencies for Deployment
      if: steps.check-creds.outputs.skip-deployment == 'false'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install azure-cli
        
    - name: üì¶ Create Deployment Package
      if: steps.check-creds.outputs.skip-deployment == 'false'
      run: |
        # Create deployment package with correct structure
        zip -r space-debris-assessment.zip main.py requirements.txt app/ LICENSE README.md
        
    - name: üöÄ Deploy to Azure App Service
      if: steps.check-creds.outputs.skip-deployment == 'false'
      run: |
        az webapp deployment source config-zip \
          --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
          --name "${{ env.AZURE_APP_NAME }}" \
          --src space-debris-assessment.zip
        
    - name: üß™ Test Live Deployment
      if: steps.check-creds.outputs.skip-deployment == 'false'
      run: |
        # Wait for deployment to complete
        sleep 45
        
        # Test the live API
        APP_URL="https://${{ env.AZURE_APP_NAME }}.azurewebsites.net"
        curl -f "$APP_URL/api/health" || exit 1
        curl -f "$APP_URL/" || exit 1
        
        echo "‚úÖ Live deployment test passed"
      continue-on-error: true
      
  performance-test:
    name: ‚ö° Performance Test
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: üöÄ Checkout Code
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üîß Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install memory-profiler psutil
        
    - name: üìä Performance Benchmark
      run: |
        python -c "
        import time
        import psutil
        import os
        
        # Memory usage before
        process = psutil.Process(os.getpid())
        mem_before = process.memory_info().rss / 1024 / 1024
        
        # Time the application
        start_time = time.time()
        
        # Test the main application performance
        from main import app
        with app.test_client() as client:
            response = client.get('/api/health')
            assert response.status_code == 200
        
        end_time = time.time()
        
        # Memory usage after
        mem_after = process.memory_info().rss / 1024 / 1024
        
        print(f'‚ö° Performance Results:')
        print(f'   Execution Time: {end_time - start_time:.2f} seconds')
        print(f'   Memory Usage: {mem_after:.2f} MB (Delta: {mem_after - mem_before:.2f} MB)')
        "
        
  azure-info:
    name: ‚ÑπÔ∏è Azure Deployment Info
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üìã Azure Setup Instructions
      run: |
        if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
          echo "‚ö†Ô∏è Azure Deployment Skipped"
          echo "================================"
          echo "Azure deployment was skipped because AZURE_CREDENTIALS secret is not configured."
          echo ""
          echo "To enable Azure deployment:"
          echo "1. Create an Azure service principal:"
          echo "   az ad sp create-for-rbac --name 'space-debris-github-actions' \\"
          echo "     --role contributor \\"
          echo "     --scopes /subscriptions/{subscription-id}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }} \\"
          echo "     --sdk-auth"
          echo ""
          echo "2. Add the output as AZURE_CREDENTIALS secret in your GitHub repository"
          echo "3. Create Azure resources:"
          echo "   az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location eastus"
          echo "   az webapp create --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \\"
          echo "     --plan myAppServicePlan --name ${{ env.AZURE_APP_NAME }} --runtime 'PYTHON|3.11'"
          echo ""
          echo "For more information, see: https://github.com/Azure/login#configure-deployment-credentials"
          echo ""
          echo "‚úÖ Application testing and building completed successfully!"
        else
          echo "‚úÖ Azure credentials are configured - deployment available through deploy-azure job"
        fi
