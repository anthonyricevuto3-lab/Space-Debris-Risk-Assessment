name: Cross-Platform Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC

jobs:
  test-matrix:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11']
        exclude:
          # Exclude some combinations to speed up CI
          - os: macos-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.9'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Test that our optimized TLE parser works
        python -c "import app_standalone; print('âœ… App import successful')"
        
    - name: Test TLE Data Loading
      run: |
        python -c "
        import app_standalone
        print('ðŸ§ª Testing optimized TLE parser...')
        
        # Test TLE data fetch
        data = app_standalone.optimized_fetch_celestrack_tle()
        assert data is not None, 'Failed to fetch TLE data'
        assert len(data) == 3, f'Expected 3 objects, got {len(data)}'
        print(f'âœ… TLE data test passed: {len(data)} objects loaded')
        
        # Test scoring system
        for debris in data:
            score = debris['risk_assessment']['earth_impact_score']
            prob = debris['risk_assessment']['impact_probability_percent']
            assert 0 <= score <= 5, f'Risk score {score} out of range [0,5]'
            assert 0 <= prob <= 100, f'Impact probability {prob} out of range [0,100]'
            
        print('âœ… All tests passed')
        "
        
    - name: Test Flask API
      run: |
        python -c "
        from app_standalone import app
        
        with app.test_client() as client:
            response = client.get('/health')
            assert response.status_code == 200, 'Health endpoint failed'
            
            response = client.get('/api/top-risks')
            assert response.status_code == 200, 'API endpoint failed'
            
            data = response.get_json()
            assert isinstance(data, list), 'API should return a list'
            assert len(data) == 3, f'Expected 3 objects, got {len(data)}'
            
            print('âœ… Flask API tests passed')
        "
        "
        
    - name: Test Main Application
      run: |
        python test_ml_app.py --max-pairs 3 --format summary
        
    - name: Performance Benchmark
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      run: |
        python -c "
        import time
        import subprocess
        import sys
        
        start_time = time.time()
        result = subprocess.run([sys.executable, 'test_ml_app.py', '--max-pairs', '10'], 
                              capture_output=True, text=True)
        end_time = time.time()
        
        if result.returncode == 0:
            print(f'Performance: {end_time - start_time:.2f} seconds for 10 pairs')
        else:
            print(f'Error: {result.stderr}')
            sys.exit(1)
        "
        
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Check Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
        
        # Check for known security vulnerabilities (continue on error)
        safety check --json || echo "Security scan completed with warnings"
        
        # Static security analysis (continue on error)
        bandit -r src/ -f json || echo "Static analysis completed with warnings"
        
  data-validation:
    name: TLE Data Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Test that our optimized TLE parser works
        python -c "import app_standalone; print('âœ… App import successful')"
        
    - name: Validate TLE Data Quality
      run: |
        python -c "
        import sys
        import os
        sys.path.append('.')
        from test_ml_app import DebrisRiskTester
        
        tester = DebrisRiskTester()
        result = tester.load_tle_data()
        assert result, 'TLE data loading failed'
        
        # Validate data quality
        satellites = tester.satellites
        assert len(satellites) >= 10, f'Insufficient TLE data: {len(satellites)} objects'
        
        for i, sat in enumerate(satellites[:5]):
            assert 'name' in sat, f'Missing name in satellite {i}'
            assert 'line1' in sat, f'Missing line1 in satellite {i}'
            assert 'line2' in sat, f'Missing line2 in satellite {i}'
            assert 'norad_id' in sat, f'Missing norad_id in satellite {i}'
            
        print(f'TLE data validation passed: {len(satellites)} objects verified')
        "
        
    - name: Validate Risk Calculations
      run: |
        python -c "
        import sys
        sys.path.append('src')
        from risk_model import DebrisRiskModel
        
        model = DebrisRiskModel()
        
        # Test edge cases with proper satellite/target format
        test_cases = [
            ({'altitude': 100, 'eccentricity': 0.2, 'inclination': 45}, {'altitude': 110, 'eccentricity': 0.1, 'inclination': 46}),   # Very low altitude
            ({'altitude': 800, 'eccentricity': 0.0, 'inclination': 98}, {'altitude': 805, 'eccentricity': 0.001, 'inclination': 99}), # High altitude, circular
            ({'altitude': 400, 'eccentricity': 0.1, 'inclination': 51.6}, {'altitude': 410, 'eccentricity': 0.05, 'inclination': 52}), # ISS-like orbit
        ]
        
        for i, (satellite, target) in enumerate(test_cases):
            risk = model.predict_risk(satellite, target)
            assert 0 <= risk <= 1, f'Invalid risk score {risk} for test case {i}'
            print(f'Test case {i+1}: risk={risk:.3f}')
            
        print('Risk calculation validation passed')
        "
