name: Cross-Platform Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC

jobs:
  test-matrix:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11']
        exclude:
          # Exclude some combinations to speed up CI
          - os: macos-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.9'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Test that our main application works
        python -c "import main; print('App import successful')"
        
    - name: Test Flask Application
      run: |
        python -c "
        from main import app
        print('Testing main application...')
        
        # Test Flask app
        with app.test_client() as client:
            response = client.get('/health')
            assert response.status_code == 200, 'Health check failed'
            print('Health check passed')
            
            response = client.get('/')
            assert response.status_code == 200, 'Main page failed'
            print('Main page test passed')
            
        print('All tests passed')
        "
        
    - name: Test API Endpoints
      run: |
        python -c "
        from main import app
        
        with app.test_client() as client:
            response = client.get('/health')
            assert response.status_code == 200, 'Health endpoint failed'
            print('Health endpoint test passed')
            
            response = client.get('/')
            assert response.status_code == 200, 'Main page failed'
            print('Main page test passed')
        "
        
    - name: Performance Test
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      run: |
        python -c "
        import time
        from main import app
        
        # Performance benchmark
        start_time = time.time()
        with app.test_client() as client:
            for i in range(5):
                response = client.get('/health')
                assert response.status_code == 200
        end_time = time.time()
        
        print(f'Performance: {end_time - start_time:.3f} seconds for 5 health checks')
        print('Performance test passed')
        "
        
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Check Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
        
        # Check for known security vulnerabilities (continue on error)
        safety check --json || echo "Security scan completed with warnings"
        
        # Static security analysis (continue on error)
        bandit -r . --exclude="./.github/,./venv/,./env/,./__pycache__/" -f json || echo "Static analysis completed with warnings"
        
  application-validation:
    name: Application Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Validate Application Structure
      run: |
        python -c "
        from main import app
        import os
        
        print('Validating application structure...')
        
        # Check that Flask app is created properly
        assert app is not None, 'Flask app creation failed'
        print('Flask app creation validated')
        
        # Check that required files exist
        required_files = ['main.py', 'requirements.txt', 'templates/index.html']
        for file in required_files:
            assert os.path.exists(file), f'Required file missing: {file}'
        
        print('File structure validation passed')
        
        # Test app functionality
        with app.test_client() as client:
            response = client.get('/health')
            assert response.status_code == 200, 'Health endpoint failed'
            
            response = client.get('/')
            assert response.status_code == 200, 'Main page failed'
            
        print('Application validation completed successfully')
        "
