name: ðŸŒ Cross-Platform Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC

jobs:
  test-matrix:
    name: ðŸ§ª Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11']
        exclude:
          # Exclude some combinations to speed up CI
          - os: macos-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.9'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-core.txt
        # Install optional dependencies individually
        pip install sgp4>=2.20 || echo "sgp4 installation skipped"
        
    - name: ðŸ§ª Test TLE Data Loading
      run: |
        python -c "
        import sys
        import os
        sys.path.append('.')
        from test_ml_app import DebrisRiskTester
        tester = DebrisRiskTester()
        result = tester.load_tle_data()
        assert result, 'TLE data loading failed'
        assert len(tester.satellites) > 0, 'No satellites loaded'
        print(f'âœ… TLE loading test passed on {sys.platform}: {len(tester.satellites)} objects')
        "
        
    - name: ðŸŽ¯ Test Risk Model
      run: |
        python -c "
        import sys
        sys.path.append('src')
        from risk_model import DebrisRiskModel
        model = DebrisRiskModel()
        # Create mock satellite and target data for testing
        satellite = {'altitude': 400, 'eccentricity': 0.01, 'inclination': 51.6}
        target = {'altitude': 410, 'eccentricity': 0.05, 'inclination': 52.0}
        risk = model.predict_risk(satellite, target)
        assert 0 <= risk <= 1, f'Risk score {risk} out of range'
        print(f'âœ… Risk model test passed on {sys.platform}: risk={risk:.3f}')
        "
        
    - name: ðŸš€ Test Main Application
      run: |
        python test_ml_app.py --max-pairs 3 --format summary
        
    - name: ðŸ“Š Performance Benchmark
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      run: |
        python -c "
        import time
        import subprocess
        import sys
        
        start_time = time.time()
        result = subprocess.run([sys.executable, 'test_ml_app.py', '--max-pairs', '10'], 
                              capture_output=True, text=True)
        end_time = time.time()
        
        if result.returncode == 0:
            print(f'âš¡ Performance: {end_time - start_time:.2f} seconds for 10 pairs')
        else:
            print(f'âŒ Error: {result.stderr}')
            sys.exit(1)
        "
        
  dependency-check:
    name: ðŸ” Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ðŸ”’ Check Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
        
        # Check for known security vulnerabilities (continue on error)
        safety check --json || echo "âš ï¸ Security scan completed with warnings"
        
        # Static security analysis (continue on error)
        bandit -r src/ -f json || echo "âš ï¸ Static analysis completed with warnings"
        
  data-validation:
    name: ðŸ“¡ TLE Data Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install Dependencies
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-core.txt
        # Install optional dependencies individually
        pip install sgp4>=2.20 || echo "sgp4 installation skipped"
        
    - name: ðŸ›°ï¸ Validate TLE Data Quality
      run: |
        python -c "
        import sys
        import os
        sys.path.append('.')
        from test_ml_app import DebrisRiskTester
        
        tester = DebrisRiskTester()
        result = tester.load_tle_data()
        assert result, 'TLE data loading failed'
        
        # Validate data quality
        satellites = tester.satellites
        assert len(satellites) >= 10, f'Insufficient TLE data: {len(satellites)} objects'
        
        for i, sat in enumerate(satellites[:5]):
            assert 'name' in sat, f'Missing name in satellite {i}'
            assert 'line1' in sat, f'Missing line1 in satellite {i}'
            assert 'line2' in sat, f'Missing line2 in satellite {i}'
            assert 'norad_id' in sat, f'Missing norad_id in satellite {i}'
            
        print(f'âœ… TLE data validation passed: {len(satellites)} objects verified')
        "
        
    - name: ðŸŽ¯ Validate Risk Calculations
      run: |
        python -c "
        import sys
        sys.path.append('src')
        from risk_model import DebrisRiskModel
        
        model = DebrisRiskModel()
        
        # Test edge cases with proper satellite/target format
        test_cases = [
            ({'altitude': 100, 'eccentricity': 0.2, 'inclination': 45}, {'altitude': 110, 'eccentricity': 0.1, 'inclination': 46}),   # Very low altitude
            ({'altitude': 800, 'eccentricity': 0.0, 'inclination': 98}, {'altitude': 805, 'eccentricity': 0.001, 'inclination': 99}), # High altitude, circular
            ({'altitude': 400, 'eccentricity': 0.1, 'inclination': 51.6}, {'altitude': 410, 'eccentricity': 0.05, 'inclination': 52}), # ISS-like orbit
        ]
        
        for i, (satellite, target) in enumerate(test_cases):
            risk = model.predict_risk(satellite, target)
            assert 0 <= risk <= 1, f'Invalid risk score {risk} for test case {i}'
            print(f'Test case {i+1}: risk={risk:.3f}')
            
        print('âœ… Risk calculation validation passed')
        "
